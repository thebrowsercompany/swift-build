name: Setup build
description: Sets up the build environment for the current job

inputs:
  windows-sdk-version:
    description: The Windows SDK version to use, e.g. "10.0.22621.0"
    required: false
    type: string
  msvc-version:
    description: The Windows MSVC version to use, e.g. "14.42"
    required: false
    type: string
  setup-vs-dev-env:
    description: Whether to set up a Visual Studio Dev Environment
    default: false
    required: false
    type: boolean
  host-arch:
    description: |
      The output's host architecture, "x86", "amd64" or "arm64". Defaults to the build architecture
      (a.k.a. the current runner's architecture).
      This is the target architecture for the Visual Studio Developer Environment.
    required: false
    type: string
  swift-version:
    description: The Swift version to use, e.g. "6.0.1" for the upstream Apple Swift repository.
      Or "6.0.0-20261216.0" for a specific snapshot from another repository.
      If unspecified, the Swift toolchain is not set up.
    required: false
    type: string
  swift-repo:
    description: |
      The Swift repository to use, e.g. "thebrowsercompany/swift-build". If unspecified, and
      `swift-version` is specified, the upstream Apple Swift repository is used.
    required: false
    type: string

outputs:
  windows-build-tools-version:
    description: |
      The full version of the Windows build tools installed, eg. "14.42.34433". This is only set
      if the `msvc-version` input was provided, and only on Windows.
    value: ${{ steps.setup-msvc.outputs.windows-build-tools-version }}

runs:
  using: composite
  steps:
    - name: Sanitize input
      id: sanitize-input
      shell: pwsh
      run: |
        if ($IsWindows) {
          $BuildOS = "windows"
        } elseif ($IsMacOS) {
          $BuildOS = "macosx"
        } else {
          Write-Output "::error::Unsupported build OS."
          exit 1
        }

        $Arch = ([System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture).ToString()
        switch ($Arch) {
          "X64" { $BuildArch = "amd64" }
          "Arm64" { $BuildArch = "arm64" }
          default {
            Write-Output "::error::Unsupported build architecture: `"$Arch`""
            exit 1
          }
        }

        # Validate the MSVC version input.
        # If specified, it is expected to have a format "major.minor", without the build and
        # revision numbers. When a value such as "14.42" is parsed as a `System.Version`, the build
        # and revision numbers in that object are set to -1.
        $MSVCVersion = "${{ inputs.msvc-version }}"
        if ($MSVCVersion -ne "") {
          $ParsedMSVCVersion = [System.Version]::Parse($MSVCVersion)
          if ($ParsedMSVCVersion -eq $null) {
            Write-Output "::error::Invalid Windows MSVC version: `"${MSVCVersion}`"."
            exit 1
          }
          if ($ParsedMSVCVersion.Major -ne 14) {
            Write-Output "::error::Unsupported Windows MSVC version (major version not supported): `"${MSVCVersion}`"."
            exit 1
          }
          if ($ParsedMSVCVersion.Build -ne -1) {
            Write-Output "::error::Unsupported Windows MSVC version (build version was specified): `"${MSVCVersion}`"."
            exit 1
          }
          if ($ParsedMSVCVersion.Revision -ne -1) {
            Write-Output "::error::Unsupported Windows MSVC version (revision version was specified): `"${MSVCVersion}`"."
            exit 1
          }
        }

        if ("${{ inputs.setup-vs-dev-env }}" -eq "true") {
          switch ("${{ inputs.host-arch }}") {
            "x86" { $HostArch = "x86" }
            "amd64" { $HostArch = "amd64" }
            "arm64" { $HostArch = "arm64" }
            "" { $HostArch = $BuildArch }
            default {
              Write-Output "::error::Unsupported host architecture: `"${{ inputs.host-arch }}`""
              exit 1
            }
          }
        } else {
          $HostArch = $BuildArch
        }

        ${SwiftVersion} = "${{ inputs.swift-version }}"
        ${SwiftRepo} = "${{ inputs.swift-repo }}"
        if ($SwiftRepo -ne "" -and $SwiftVersion -eq "") {
          Write-Output "::error::The `swift-repo` input was specified, but the `swift-version` input was not. Please specify a Swift toolchain version to use."
          exit 1
        }

        Write-Output "‚ÑπÔ∏è Build OS: $BuildOS"
        Write-Output "‚ÑπÔ∏è Build architecture: $BuildArch"
        Write-Output "‚ÑπÔ∏è Host architecture: $HostArch"

        # Derive the Swift version and repository from the inputs.
        if ($SwiftVersion -ne "") {
          if ($SwiftRepo -eq "") {
            $SwiftBranch = "swift-${SwiftVersion}-release"
            $SwiftTag = "${SwiftVersion}-RELEASE"
            Write-Output "‚ÑπÔ∏è Using upstream Swift toolchain: $SwiftVersion (branch: $SwiftBranch, tag: $SwiftTag)"
          } else {
            # Note: This only supports Windows for now.
            $SwiftReleaseAssetName = "installer-${BuildArch}.exe"
            $SwiftReleaseTagName = "swift-${SwiftVersion}"
            Write-Output "‚ÑπÔ∏è Using custom Swift toolchain: $SwiftVersion (repository: $SwiftRepo, tag: $SwiftReleaseTagName, asset: $SwiftReleaseAssetName)"
          }
        }

        @"
        build-os=$BuildOS
        build-arch=$BuildArch
        host-arch=$HostArch
        swift-branch=$SwiftBranch
        swift-tag=$SwiftTag
        swift-release-asset=$SwiftReleaseAssetName
        swift-release-tag=$SwiftReleaseTagName
        "@ | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

    # - name: Install Windows SDK version ${{ inputs.windows-sdk-version }}
    #   if: steps.sanitize-input.outputs.build-os == 'windows' && inputs.windows-sdk-version != ''
    #   id: setup-windows-sdk
    #   shell: pwsh
    #   run: |
    #     $WinSdkVersionString = "${{ inputs.windows-sdk-version }}"
    #     $WinSdkVersion = [System.Version]::Parse($WinSdkVersionString)
    #     $WinSdkVersionBuild = $WinSdkVersion.Build

    #     $Win10SdkRoot = Get-ItemPropertyValue `
    #       -Path "Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Kits\Installed Roots" `
    #       -Name "KitsRoot10"
    #     $Win10SdkLib = Join-Path $Win10SdkRoot "Lib"
    #     $Win10SdkInclude = Join-Path $Win10SdkRoot "Include"
    #     $Win10SdkIncludeVersion = Join-Path $Win10SdkInclude $WinSdkVersionString

    #     if (Test-Path -Path $Win10SdkIncludeVersion -PathType Container) {
    #       Write-Output "‚ÑπÔ∏è MSVCPackageVersionWindows SDK ${WinSdkVersionString} already installed."
    #     } else {
    #       # Install the missing SDK.
    #       Write-Output "‚ÑπÔ∏è Installing Windows SDK ${WinSdkVersionString}..."

    #       $InstallerLocation = Join-Path "${env:ProgramFiles(x86)}" "Microsoft Visual Studio" "Installer"
    #       $VSWhere = Join-Path "${InstallerLocation}" "VSWhere.exe"
    #       $VSInstaller = Join-Path "${InstallerLocation}" "vs_installer.exe"
    #       $InstallPath = (& "$VSWhere" -latest -products * -format json | ConvertFrom-Json).installationPath
    #       $process = Start-Process "$VSInstaller" `
    #           -PassThru `
    #           -ArgumentList "modify", `
    #               "--noUpdateInstaller", `
    #               "--installPath", "`"$InstallPath`"", `
    #               "--channelId", "https://aka.ms/vs/17/release/channel", `
    #               "--quiet", "--norestart", "--nocache", `
    #               "--add", "Microsoft.VisualStudio.Component.Windows11SDK.${WinSdkVersionBuild}"
    #       $process.WaitForExit()

    #       if (Test-Path -Path $Win10SdkIncludeVersion -PathType Container) {
    #         Write-Output "‚ÑπÔ∏è Windows SDK ${WinSdkVersionString} installed successfully."
    #       } else {
    #         Write-Output "::error::Failed to install Windows SDK ${WinSdkVersionString}. Check the installer log for details."
    #         $LogFile = Get-ChildItem "${env:TEMP}" -Filter "dd_installer_*.log" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
    #         "log-file=$($LogFile.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
    #         exit 1
    #       }
    #     }

    #     # Remove more recent Windows SDKs, if present. This is used to work
    #     # around issues where LLVM uses the most recent Windows SDK.
    #     # This should be removed once a more permanent solution is found.
    #     # See https://github.com/compnerd/swift-build/issues/958 for details.
    #     Get-ChildItem -Path $Win10SdkInclude -Directory | ForEach-Object {
    #       $IncludeDirName = $_.Name
    #       try {
    #         $IncludeDirVersion = [System.Version]::Parse($IncludeDirName)
    #         if ($IncludeDirVersion -gt $WinSdkVersion) {
    #           $LibDirVersion = Join-Path $Win10SdkLib $IncludeDirName
    #           Write-Output "‚ÑπÔ∏è Removing folders for Windows SDK ${IncludeDirVersion}."
    #           Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction Ignore
    #           Remove-Item -Path $LibDirVersion -Recurse -Force -ErrorAction Ignore
    #         }
    #       } catch {
    #         # Skip if the directory cannot be parsed as a version.
    #       }
    #     }

    # - name: Upload installer log
    #   if: always() && steps.setup-windows-sdk.outputs.log-file != ''
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: ${{ github.job }}-windows-sdk-installer-log
    #     path: ${{ steps.setup-windows-sdk.outputs.log-file }}

    # - name: Dump Windows SDK installer log
      # if: always() && steps.setup-windows-sdk.outputs.log-file != ''
      # shell: pwsh
      # run: |
      #   $LogFile = "${{ steps.setup-windows-sdk.outputs.log-file }}"
      #   if (Test-Path -Path $LogFile) {
      #     Write-Output "üìã Windows SDK installer log contents:"
      #     Write-Output "=========================================="
      #     Get-Content -Path $LogFile -Raw
      #     Write-Output "=========================================="
      #   } else {
      #     Write-Output "‚ö†Ô∏è Log file not found: $LogFile"
      #   }

    # - name: Clean Visual Studio Packages Channels
    #   if: steps.sanitize-input.outputs.build-os == 'windows' && inputs.msvc-version != ''
    #   shell: pwsh
    #   run: |
    #     $ChannelsPath = Join-Path $env:ProgramData "Microsoft\VisualStudio\Packages\_Channels"
    #     Write-Output "üßπ Cleaning Visual Studio Packages Channels directory: $ChannelsPath"
    #     
    #     if (Test-Path -Path $ChannelsPath -PathType Container) {
    #       $AllItems = Get-ChildItem -Path $ChannelsPath -Recurse -Force
    #       $Files = $AllItems | Where-Object { $_.PSIsContainer -eq $false }
    #       $Directories = $AllItems | Where-Object { $_.PSIsContainer -eq $true }
    #       
    #       if ($AllItems.Count -gt 0) {
    #         Write-Output "üìã Found $($Files.Count) files and $($Directories.Count) directories in _Channels:"
    #         foreach ($Item in $AllItems) {
    #           $Type = if ($Item.PSIsContainer) { "DIR" } else { "FILE" }
    #           Write-Output "  [$Type] $($Item.FullName)"
    #         }
    #         Write-Output "üóëÔ∏è Deleting all files and directories..."
    #         Remove-Item -Path $ChannelsPath -Recurse -Force
    #         Write-Output "‚úÖ Successfully deleted all files and directories in _Channels directory"
    #       } else {
    #         Write-Output "‚ÑπÔ∏è No files or directories found in _Channels directory"
    #       }
    #     } else {
    #       Write-Output "‚ÑπÔ∏è _Channels directory does not exist"
    #     }

   #  name: Dump Visual Studio Packages Channels
   #  if: always() 
   #  shell: pwsh
   #  run: |
   #    $ChannelsPath = Join-Path $env:ProgramData "Microsoft\VisualStudio\Packages\_Channels"
   #    Write-Output "üßπ Looking up Visual Studio Packages Channels directory: $ChannelsPath"
   #    
   #    if (Test-Path -Path $ChannelsPath -PathType Container) {
   #      $AllItems = Get-ChildItem -Path $ChannelsPath -Recurse -Force
   #      $Files = $AllItems | Where-Object { $_.PSIsContainer -eq $false }
   #      $Directories = $AllItems | Where-Object { $_.PSIsContainer -eq $true }
   #      
   #      if ($AllItems.Count -gt 0) {
   #        Write-Output "üìã Found $($Files.Count) files and $($Directories.Count) directories in _Channels:"
   #        foreach ($Item in $AllItems) {
   #          $Type = if ($Item.PSIsContainer) { "DIR" } else { "FILE" }
   #          Write-Output "  [$Type] $($Item.FullName)"
   #        }
   #        Write-Output "üìã Channel file contents:"
   #        foreach ($Item in $Files) {
   #          Write-Output "üìã $($Item.FullName)"
   #          Write-Output "=========================================="
   #          Get-Content -Path $($Item.FullName) -Raw
   #          Write-Output "==========================================" 
   #        }
   #      } else {
   #        Write-Output "‚ÑπÔ∏è No files or directories found in _Channels directory"
   #      }
   #    } else {
   #      Write-Output "‚ÑπÔ∏è _Channels directory does not exist"
   #    }
  
    - name: Update VS installer 
      if: steps.sanitize-input.outputs.build-os == 'windows' && inputs.msvc-version != ''
      id: update-vs-installer
      shell: pwsh
      run: |
        $InstallerLocation = Join-PATH (Join-Path "${env:ProgramFiles(x86)}" "Microsoft Visual Studio") "Installer"
        $VSWhere = Join-Path "${InstallerLocation}" "VSWhere.exe"
        $VSInstaller = Join-Path "${InstallerLocation}" "vs_installer.exe"
        $InstallPath = (& "$VSWhere" -latest -products * -format json | ConvertFrom-Json).installationPath
        
        # Install the missing MSVC version.
        Write-Output "‚ÑπÔ∏è VS installer location: $VSInstaller"
        Write-Output "‚ÑπÔ∏è VS where location: $VSWhere"
        Write-Output "‚ÑπÔ∏è VS install path: $InstallPath"
        Write-Output "‚ÑπÔ∏è VS installer location: $InstallerLocation"

        Write-Output "‚ÑπÔ∏è Updating VS installer ..."
                 Write-Output "Start-Process `"$VSInstaller`" -PassThru -ArgumentList `"--installPath`", `"`"$InstallPath`"`", `"--quiet`", `"--norestart`", `"--nocache`" "
        $process = Start-Process "$VSInstaller" -PassThru -ArgumentList "update", "--installPath", "`"$InstallPath`"", "--quiet", "--norestart", "--nocache" 
        $process.WaitForExit()
        $ExitCode = $process.ExitCode

        Write-Output "‚è∞ Waiting for 60 seconds after VS installer update..."
        Start-Sleep -Seconds 120
        Write-Output "‚úÖ Wait completed."
         
        Write-Output "‚ÑπÔ∏è VS installer update completed with exit code: $ExitCode"
         
        if ($ExitCode -ne 0) {
          Write-Output "::error::VS installer update failed with exit code: $ExitCode"
          $LogFile = Get-ChildItem "${env:TEMP}" -Filter "dd_installer_*.log" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($LogFile) {
            "log-file=$($LogFile.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }
          exit 1
        } else {
          Write-Output "‚ÑπÔ∏è VS installer updated successfully."
        }
  
    - name: Upload vsinstaller installer log
      if: always() && steps.update-vs-installer.outputs.log-file != ''
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.job }}-vsinstaller-installer-log
        path: ${{ steps.update-vs-installer.outputs.log-file }}

    - name: Dump MSVC installer log
      if: always() && steps.update-vs-installer.outputs.log-file != ''
      shell: pwsh
      run: |
        $LogFile = "${{ steps.update-vs-installer.outputs.log-file }}"
        if (Test-Path -Path $LogFile) {
          Write-Output "üìã MSVC installer log contents:"
          Write-Output "=========================================="
          Get-Content -Path $LogFile -Raw
          Write-Output "=========================================="
        } else {
          Write-Output "‚ö†Ô∏è Log file not found: $LogFile"
        }


    - name: Install Windows MSVC version ${{ inputs.msvc-version }}
      if: steps.sanitize-input.outputs.build-os == 'windows' && inputs.msvc-version != ''
      id: setup-msvc
      shell: pwsh
      run: |
        # This is assuming a VS2022 toolchain. e.g.
        # MSVC 14.42 corresponds to the 14.42.17.12 package.
        # MSVC 14.43 corresponds to the 14.43.17.13 package.
        $MSVCVersionString = "${{ inputs.msvc-version }}"

        $InstallerLocation = Join-Path (Join-Path "${env:ProgramFiles(x86)}" "Microsoft Visual Studio") "Installer"
        $VSWhere = Join-Path "${InstallerLocation}" "VSWhere.exe"
        $VSInstaller = Join-Path "${InstallerLocation}" "vs_installer.exe"
        $InstallPath = (& "$VSWhere" -latest -products * -format json | ConvertFrom-Json).installationPath
        $MSVCDir = Join-Path (Join-Path (Join-Path $InstallPath "VC") "Tools") "MSVC"

        # Compute the MSVC version package name from the MSVC version, assuming this is coming from
        # a VS2022 installation. The version package follows the following format:
        # * Major and minor version are the same as the MSVC version.
        # * Build version is always 17 (VS2002 is VS17).
        # * The revision is set to the number of minor versions since VS17 release.
        $MSVCVersion = [System.Version]::Parse($MSVCVersionString)
        $MajorVersion = $MSVCVersion.Major
        $MinorVersion = $MSVCVersion.Minor
        $BuildVersion = 17
        $RevisionVersion = $MinorVersion - 30
        $MSVCPackageVersion = "${MajorVersion}.${MinorVersion}.${BuildVersion}.${RevisionVersion}"

        # Install the missing MSVC version.
        Write-Output "‚ÑπÔ∏è Installing MSVC packages for ${MSVCPackageVersion}..."
        $process = Start-Process "$VSInstaller" `
            -PassThru `
            -ArgumentList "modify", `
                "--installPath", "`"$InstallPath`"", `
                "--channelId", "https://aka.ms/vs/17/release/channel", `
                "--quiet", "--norestart", "--nocache", `
                "--add", "Microsoft.VisualStudio.Component.VC.${MSVCPackageVersion}.x86.x64", `
                "--add", "Microsoft.VisualStudio.Component.VC.${MSVCPackageVersion}.ATL", `
                "--add", "Microsoft.VisualStudio.Component.VC.${MSVCPackageVersion}.ARM64", `
                "--add", "Microsoft.VisualStudio.Component.VC.${MSVCPackageVersion}.ATL.ARM64"
        $process.WaitForExit()

        # Check if the MSVC version was installed successfully.
        $MSVCBuildToolsVersion = ""
        Write-Output "MSVCDir: $MSVCDir"
        Write-Output "Looking for MSVCVersionString: $MSVCVersionString"
        foreach ($dir in Get-ChildItem -Path $MSVCDir -Directory) {
          $MSVCDirName = $dir.Name
          Write-Output "  == Found MSVCDirName: $MSVCDirName"
          if ($MSVCDirName.StartsWith($MSVCVersionString)) {
            Write-Output "‚ÑπÔ∏è MSVC ${MSVCVersionString} installed successfully."
            $MSVCBuildToolsVersion = $MsvcDirName
            break
          }
        }

        if ($MSVCBuildToolsVersion -eq "") {
          Write-Output "::error::Failed to install MSVC ${MSVCVersionString}. Check the installer log for details."
          $LogFile = Get-ChildItem "${env:TEMP}" -Filter "dd_installer_*.log" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          "log-file=$($LogFile.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          exit 1
        } else {
          Write-Output "‚ÑπÔ∏è MSVC ${MSVCBuildToolsVersion} installed successfully."
          "windows-build-tools-version=${MSVCBuildToolsVersion}" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        }

    - name: Upload installer log
      if: always() && steps.setup-msvc.outputs.log-file != ''
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.job }}-msvc-installer-log
        path: ${{ steps.setup-msvc.outputs.log-file }}

    - name: Dump MSVC installer log
      if: always() && steps.setup-msvc.outputs.log-file != ''
      shell: pwsh
      run: |
        $LogFile = "${{ steps.setup-msvc.outputs.log-file }}"
        if (Test-Path -Path $LogFile) {
          Write-Output "üìã MSVC installer log contents:"
          Write-Output "=========================================="
          Get-Content -Path $LogFile -Raw
          Write-Output "=========================================="
        } else {
          Write-Output "‚ö†Ô∏è Log file not found: $LogFile"
        }

    - name: Dump Visual Studio Packages Channels
      if: always() 
      shell: pwsh
      run: |
        $ChannelsPath = Join-Path $env:ProgramData "Microsoft\VisualStudio\Packages\_Channels"
        Write-Output "üßπ Looking up Visual Studio Packages Channels directory: $ChannelsPath"
        
        if (Test-Path -Path $ChannelsPath -PathType Container) {
          $AllItems = Get-ChildItem -Path $ChannelsPath -Recurse -Force
          $Files = $AllItems | Where-Object { $_.PSIsContainer -eq $false }
          $Directories = $AllItems | Where-Object { $_.PSIsContainer -eq $true }
          
          if ($AllItems.Count -gt 0) {
            Write-Output "üìã Found $($Files.Count) files and $($Directories.Count) directories in _Channels:"
            foreach ($Item in $AllItems) {
              $Type = if ($Item.PSIsContainer) { "DIR" } else { "FILE" }
              Write-Output "  [$Type] $($Item.FullName)"
            }
            Write-Output "üìã Channel file contents:"
            foreach ($Item in $Files) {
              Write-Output "üìã $($Item.FullName)"
              Write-Output "=========================================="
              Get-Content -Path $($Item.FullName) -Raw
              Write-Output "==========================================" 
            }
          } else {
            Write-Output "‚ÑπÔ∏è No files or directories found in _Channels directory"
          }
        } else {
          Write-Output "‚ÑπÔ∏è _Channels directory does not exist"
        }


    - name: Setup Visual Studio Developer Environment
      if: steps.sanitize-input.outputs.build-os == 'windows' && inputs.setup-vs-dev-env == 'true'
      uses: compnerd/gha-setup-vsdevenv@5eb3eae1490d4f7875d574c4973539f69109700d # main
      with:
        host_arch: ${{ steps.sanitize-input.outputs.build-arch }}
        arch: ${{ steps.sanitize-input.outputs.host-arch }}
        winsdk: ${{ inputs.windows-sdk-version }}
        toolset_version: ${{ inputs.msvc-version }}

    - name: Setup Swift toolchain (Upstream)
      if: inputs.swift-version != '' && inputs.swift-repo == ''
      uses: compnerd/gha-setup-swift@6c9f2db7c3155c57fe35f160bcd5cf5859b9c1ba # main
      with:
        branch: ${{ steps.sanitize-input.outputs.swift-branch }}
        tag: ${{ steps.sanitize-input.outputs.swift-tag }}

    - name: Setup Swift toolchain (Custom)
      if: inputs.swift-version != '' && inputs.swift-repo != ''
      uses: compnerd/gha-setup-swift@6c9f2db7c3155c57fe35f160bcd5cf5859b9c1ba # main
      with:
        github-repo: ${{ inputs.swift-repo }}
        github-token: ${{ github.token }}
        release-asset-name: ${{ steps.sanitize-input.outputs.swift-release-asset }}
        release-tag-name: ${{ steps.sanitize-input.outputs.swift-release-tag }}

    - name: Update Swift toolchain module maps
      if: steps.sanitize-input.outputs.build-os == 'windows' && inputs.swift-version != ''
      shell: pwsh
      run: |
        $SwiftBinFolder = Split-Path -Path (Get-Command swift).Source -Parent
        $SwiftUsrFolder = Split-Path -Path $SwiftBinFolder -Parent
        $SwiftClangIncludeFolder = Join-Path $SwiftUsrFolder "lib" "swift" "clang" "include"
        $SwiftClangModuleMap = Join-Path $SwiftClangIncludeFolder "module.modulemap"
        curl -s `
          -H "Authorization: Bearer ${{ github.token }}" `
          https://raw.githubusercontent.com/llvm/llvm-project/main/clang/lib/Headers/module.modulemap `
          -o SwiftClangModuleMap
        if ($LASTEXITCODE -eq 0) {
          Write-Output "‚ÑπÔ∏è Updated Swift Clang module map."
        } else {
          Write-Output "::error::Failed to update Swift Clang module map. curl failed with exit code $LASTEXITCODE."
          exit 1
        }

        $WindowsSdkShareFolder = Join-Path ${env:SDKROOT} "usr" "share"

        $WinSdkModuleMap = Join-Path $WindowsSdkShareFolder "winsdk.modulemap"
        curl -s `
          -H "Authorization: Bearer ${{ github.token }}" `
          https://raw.githubusercontent.com/swiftlang/swift/main/stdlib/public/Platform/winsdk.modulemap `
          -o $WinSdkModuleMap
        if ($LASTEXITCODE -eq 0) {
          Write-Output "‚ÑπÔ∏è Updated Windows SDK module map."
        } else {
          Write-Output "::error::Failed to update Windows SDK module map. curl failed with exit code $LASTEXITCODE."
          exit 1
        }

        $UCRTModuleMap = Join-Path $WindowsSdkShareFolder "ucrt.modulemap"
        curl -s `
          -H "Authorization: Bearer ${{ github.token }}" `
          https://raw.githubusercontent.com/swiftlang/swift/main/stdlib/public/Platform/ucrt.modulemap `
          -o $UCRTModuleMap
        if ($LASTEXITCODE -eq 0) {
          Write-Output "‚ÑπÔ∏è Updated UCRT module map."
        } else {
          Write-Output "::error::Failed to update UCRT module map. curl failed with exit code $LASTEXITCODE."
          exit 1
        }

        $VCRuntimeModuleMap = Join-Path $WindowsSdkShareFolder "vcruntime.modulemap"
        curl -s `
          -H "Authorization: Bearer ${{ github.token }}" `
          https://raw.githubusercontent.com/swiftlang/swift/main/stdlib/public/Platform/vcruntime.modulemap `
          -o $VCRuntimeModuleMap
        if ($LASTEXITCODE -eq 0) {
          Write-Output "‚ÑπÔ∏è Updated VCRuntime module map."
        } else {
          Write-Output "::error::Failed to update VCRuntime module map. curl failed with exit code $LASTEXITCODE."
          exit 1
        }
