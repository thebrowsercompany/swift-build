name: Test the setup-build action
on:
  pull_request:
    branches:
      - 'main'
    paths:
      - '.github/actions/setup-build/action.yml'
      - '.github/workflows/test-setup-build.yml'
  workflow_dispatch:
    inputs:
      windows-runner:
        description: "The Windows runner to use"
        required: false
        type: string
  workflow_call:
    inputs:
      windows-runner:
        description: "The Windows runner to use"
        required: false
        type: string

env:
  TEST_WIN_SDK_VERSION: "10.0.22621.0"
  TEST_MSVC_VERSION: "14.40"
  TEST_BUILD_TOOLS_EXPECTED_VERSION: "14.40.33807"
  TEST_UPSTREAM_SWIFT_VERSION: "5.10"
  TEST_BCNY_SWIFT_VERSION: "6.0.0-20241216.0"
  TEST_BCNY_SWIFT_REPO: "thebrowsercompany/swift-build"

jobs:
  test-setup-build-windows-vs-dev-env:
    name: MSVC + WinSDK With Dev Environment
    runs-on: ${{ inputs.windows-runner || 'windows-latest' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Create test folder and files
        shell: pwsh
        run: |
          $Base = Join-Path $env:GITHUB_WORKSPACE "tmp\TestUpload"
          New-Item -ItemType Directory -Path $Base -Force | Out-Null
      
          # Create a few files of different types
          Set-Content -Path (Join-Path $Base "test.txt") -Value "dummy text content"
      
          # Echo tree for debugging
          Write-Host "Created files under $Base"
          Get-ChildItem -Recurse -Force $Base | Format-List -Property FullName, Length

      - name: Upload directory to R2 (aws s3 sync)
        env:
          SRC: ${{ github.workspace }}\tmp\TestUpload
          DEST_PREFIX: TestUpload
          R2_BUCKET: swift-toolchain
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          R2_ENDPOINT_URL: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
        run: |
          Write-Host "SRC:  ${env:SRC}"
          Write-Host "DEST_PREFIX: ${env:DEST_PREFIX}"
          Write-Host "R2_BUCKET: ${env:R2_BUCKET}"
          Write-Host "R2_ENDPOINT_URL: ${env:R2_ENDPOINT_URL}"
          Write-Host "AWS_ACCESS_KEY_ID: ${env:AWS_ACCESS_KEY_ID}"
          Write-Host "AWS_SECRET_ACCESS_KEY: ${env:AWS_SECRET_ACCESS_KEY}"
          Write-Host "AWS_DEFAULT_REGION: ${env:AWS_DEFAULT_REGION}"

          aws s3 sync "${env:SRC}" "s3://${env:R2_BUCKET}/${env:DEST_PREFIX}/" `
            --endpoint-url "${env:R2_ENDPOINT_URL}" `
            --no-progress `
            --acl private

      - name: List uploaded objects (verify)
        env:
            SRC: ${{ github.workspace }}\tmp\TestUpload
            DEST_PREFIX: TestUpload
            R2_BUCKET: swift-toolchain
            R2_ENDPOINT_URL: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
        run: |
          aws s3 ls "s3://${env:R2_BUCKET}/${env:DEST_PREFIX}/" --endpoint-url "${env:R2_ENDPOINT_URL}"
     