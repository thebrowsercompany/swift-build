name: SwiftLint

on:
  workflow_dispatch:

jobs:
  windows:
    runs-on: windows-latest

    strategy:
      matrix:
        include:
          - branch: development
            tag: DEVELOPMENT-SNAPSHOT-2023-07-10-a

    steps:
      # Build
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1
          ref: refs/heads/compnerd/windows
          repository: thebrowsercompany/SwiftLint

      - uses: compnerd/gha-setup-swift@main
        with:
          branch: ${{ matrix.branch }}
          tag: ${{ matrix.tag }}

      # TODO(compnerd) this requires linker main renaming which is not supported
      # - name: test
      #   run: swift test

      - name: build
        run: swift build -c release -Xswiftc -gnone -Xcc -g0

      # Package
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1
          ref: refs/heads/main
          path: ${{ github.workspace }}/SourceCache/swift-build

      - uses: microsoft/setup-msbuild@v1.3.1

      - name: package
        run: msbuild ${{ github.workspace }}/SourceCache/swift-build/platforms/Windows/SwiftLint.wixproj -nologo -restore -p:Configuration=Release -p:SWIFT_LINT_BUILD=${{ github.workspace }}\.build\release -p:OutputPath=${{ github.workspace }}\artifacts -p:RunWixToolsOutOfProc=true

      # Release
      - run: |
          $MSI_PATH = cygpath -m ${{ github.workspace }}\artifacts\SwiftLint.msi
          Write-Output MSI_PATH=${MSI_PATH} | Out-File -FilePath ${env:GITHUB_ENV} -Encoding utf8 -Append

      - uses: softprops/action-gh-release@v1
        with:
          draft: true
          prerelease: true
          name: SwiftLint-${{ matrix.tag }}
          tag_name: SwiftLint-${{ matrix.tag }}
          files:
            .build/x86_64-unknown-windows-msvc/release/SwiftLint.exe
            ${{ env.MSI_PATH }}
